<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Free open-source IP Leak Test to check your IP address (IPv4/IPv6), location, ISP, and VPN/Tor status with a responsive map." />
  <meta name="keywords" content="IP geolocation, IP lookup, VPN detection, Tor detection, IPv6, IPv4, location tracker, privacy tool, open source" />
  <meta name="author" content="sircryptic" />
  <meta property="og:title" content="Free Open Source IP Leak Test by sircryptic" />
  <meta property="og:description" content="Discover your IP address (IPv4/IPv6), location, and VPN/Tor status with this free open-source tool featuring a dynamic map." />
  <meta property="og:image" content="https://img.icons8.com/emoji/48/globe.png" />
  <meta property="og:url" content="https://sircryptic.github.io/ip-geolocation" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Free Open Source IP Leak Test by sircryptic" />
  <meta name="twitter:description" content="Check your IP (IPv4/IPv6), location, and VPN/Tor status for free!" />
  <meta name="twitter:image" content="https://img.icons8.com/emoji/48/globe.png" />
  <title>My IP Information</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="icon" type="image/png" href="https://img.icons8.com/emoji/48/globe.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
    }
    .container {
      max-width: 48rem;
      margin: 0 auto;
      padding: 1rem;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transform: translateY(0);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
    #map {
      height: 16rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
    }
    @media (min-width: 640px) {
      #map { height: 20rem; }
    }
    .btn-primary {
      background-color: #2563eb;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn-primary:hover:enabled {
      background-color: #1d4ed8;
      transform: scale(1.05);
    }
    .btn-primary:disabled {
      background-color: #93c5fd;
      cursor: not-allowed;
    }
    .error {
      color: #dc2626;
      font-size: 0.9rem;
    }
    .vpn-note {
      color: #4b5563;
      font-size: 0.9rem;
      font-style: italic;
    }
    footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      padding: 1rem;
      font-size: 0.9rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    footer .footer-text {
      flex-grow: 1;
      text-align: center;
    }
    footer a {
      transition: opacity 0.3s ease;
    }
    footer a:hover {
      opacity: 0.8;
    }
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #2563eb;
      border-radius: 50%;
      width: 1.5rem;
      height: 1.5rem;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .map-note {
      color: #4b5563;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body class="font-sans text-gray-800">
  <main class="container py-6 sm:py-12">
    <div class="card rounded-2xl shadow-2xl p-6 sm:p-8 space-y-6">
      <h1 class="text-2xl sm:text-3xl font-bold text-indigo-700 flex items-center gap-2">
        üåç Free Open Source IP Leak Test
      </h1>

      <div id="ip-info" class="space-y-2 text-base sm:text-lg leading-relaxed">
        <p><strong>IPv4 Address:</strong> <span id="ipv4"><span class="spinner"></span> Loading...</span></p>
        <p><strong>IPv6 Address:</strong> <span id="ipv6"><span class="spinner"></span> Loading...</span></p>
        <p id="tor-vpn" class="text-yellow-600 hidden"><strong>‚ö†Ô∏è Privacy:</strong> <span id="vpn-provider">VPN/Tor</span> detected (IP reflects VPN/Tor server)</p>
        <p><strong>User Agent:</strong> <span id="user-agent">Loading...</span></p>
        <h2 class="text-lg sm:text-xl font-semibold text-indigo-600 mt-4">üìã My IP Information</h2>
        <p><strong>ISP:</strong> <span id="isp"><span class="spinner"></span> Loading...</span></p>
        <p><strong>City:</strong> <span id="city"><span class="spinner"></span> Loading...</span></p>
        <p><strong>Region:</strong> <span id="region"><span class="spinner"></span> Loading...</span></p>
        <p><strong>Zip:</strong> <span id="zip"><span class="spinner"></span> Loading...</span></p>
        <p>
          <strong>Country:</strong> <span id="country"><span class="spinner"></span> Loading...</span>
          <img id="flag" src="" alt="Country flag" class="inline ml-2 rounded-sm shadow-sm hidden" />
        </p>
        <p><strong>Timezone:</strong> <span id="timezone"><span class="spinner"></span> Loading...</span></p>
        <p><strong>Coordinates:</strong> <span id="coordinates"><span class="spinner"></span> Loading...</span></p>
        <p id="vpn-note" class="vpn-note hidden">Note: Using a VPN/Tor may mask your real IP and location. Allow browser geolocation to see your actual position on the map. Try disabling your VPN/Tor to confirm your real IP.</p>
        <p id="error" class="error hidden"></p>
      </div>

      <div class="flex space-x-4">
        <button id="locate" class="btn-primary px-5 py-2 text-white rounded-lg shadow hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" title="Refresh your real location using browser geolocation">
          üìç Refresh Real Location
        </button>
        <button id="toggle-map" class="btn-primary px-5 py-2 text-white rounded-lg shadow hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" title="Toggle between VPN/Tor and real location views" disabled>
          Toggle Map View
        </button>
      </div>

      <div id="map"></div>
      <p class="map-note">Blue marker: IP-based location (may reflect VPN/Tor). Green marker: Your real location (requires geolocation).</p>
    </div>
  </main>

  <footer>
    <span class="footer-text">Free Open Source IP Leak Test | Developed by sircryptic | <a href="privacy.html" class="underline">Privacy Notice</a></span>
    <a href="https://github.com/sircryptic" target="_blank">
      <img src="https://img.icons8.com/fluency/24/github.png" alt="GitHub" />
    </a>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Block bots based on user-agent
    const userAgent = navigator.userAgent;
    const botPattern = /bot|robot|curl|spider|crawler/i;
    if (botPattern.test(userAgent)) {
      document.body.innerHTML = '<h1 class="text-center text-white mt-10">Access Denied</h1>';
      throw new Error('Bot detected');
    }

    // Initialize map with fallback coordinates
    let defaultLat = 0;
    let defaultLon = 0;
    let realLat = null;
    let realLon = null;
    let map = L.map('map', { zoomControl: true }).setView([defaultLat, defaultLon], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 18,
    }).addTo(map);
    L.control.scale().addTo(map);
    let ipMarker = null;
    let realMarker = null;

    // Display user agent immediately
    const userAgentElement = document.getElementById('user-agent');
    if (userAgentElement) userAgentElement.textContent = userAgent || 'Unknown';

    // List of common VPN providers
    const vpnProviders = [
      'proton', 'nordvpn', 'expressvpn', 'surfshark', 'cyberghost', 'pia', 'private internet access',
      'mullvad', 'windscribe', 'purevpn', 'ipvanish', 'tor', 'hide my ass', 'hola', 'zenmate',
      'vyprvpn', 'tunnelbear', 'pass', 'astrill', 'avg vpn', 'avast', 'datacamp', 'hotspot shield',
      'anonymous', 'privado', 'private', 'strongvpn', 'privatevpn', 'torguard', 'atlas vpn', 'ovpn', 'vpn'
    ];

    // Validate country code (ISO 3166-1 alpha-2)
    const validCountryCodes = [
      'af', 'al', 'dz', 'as', 'ad', 'ao', 'ai', 'aq', 'ag', 'ar', 'am', 'aw', 'au', 'at', 'az', 'bs', 'bh', 'bd', 'at', 'bb', 'by', 'be', 'bz', 'bj', 'bm', 'bt', 'bo', 'bq', 'ba', 'bw',
 'br', 'io', 'bn', 'bg', 'bf', 'bi', 'cv', 'kh', 'cm', 'ca', 'ky', 'cf', 'td', 'cl', 
 'cn', 'cx', 'cc', 'co', 'km', 'cg', 'cd', 'ck', 'cr', 'ci', 'hr', 'cu', 'cw', 'cy', 
 'cz', 'dk', 'dj', 'dm', 'do', 'ec', 'eg', 'sv', 'gq', 'er', 'ee', 'sz', 'et', 'fk', 
 'fo', 'fj', 'fi', 'fr', 'gf', 'pf', 'tf', 'ga', 'gm', 'ge', 'de', 'gh', 'gi', 'gr', 
 'gl', 'gd', 'gp', 'gu', 'gt', 'gg', 'gn', 'gw', 'gy', 'ht', 'hn', 'hk', 'hu', 'is', 
 'in', 'id', 'ir', 'iq', 'ie', 'im', 'il', 'it', 'jm', 'jp', 'je', 'jo', 'kz', 'ke', 
 'ki', 'kp', 'kr', 'kw', 'kg', 'la', 'lv', 'lb', 'ls', 'lr', 'ly', 'li', 'lt', 'lu', 
 'mo', 'mg', 'mw', 'my', 'mv', 'ml', 'mt', 'mh', 'mq', 'mr', 'mu', 'yt', 'mx', 'fm', 
 'md', 'mc', 'mn', 'me', 'ms', 'ma', 'mz', 'mm', 'na', 'nr', 'np', 'nl', 'nc', 'nz', 
 'ni', 'ne', 'ng', 'nu', 'nf', 'mp', 'no', 'om', 'pk', 'pw', 'ps', 'pa', 'pg', 'py', 
 'pe', 'ph', 'pn', 'pl', 'pt', 'pr', 'qa', 're', 'ro', 'ru', 'rw', 'bl', 'sh', 'kn', 
 'lc', 'mf', 'pm', 'vc', 'ws', 'sm', 'st', 'sa', 'sn', 'rs', 'sc', 'sl', 'sg', 'sx', 
 'sk', 'si', 'sb', 'so', 'za', 'ss', 'es', 'lk', 'sd', 'sr', 'sj', 'se', 'ch', 'sy', 
 'tw', 'tj', 'tz', 'th', 'tl', 'tg', 'tk', 'to', 'tt', 'tn', 'tr', 'tm', 'tc', 'tv', 
 'ug', 'ua', 'ae', 'gb', 'us', 'um', 'uy', 'uz', 'vu', 've', 'vn', 'vg', 'vi', 'wf', 
 'eh', 'ye', 'zm', 'zw'
    ];

    // IP conversion functions
    function ipv4ToIpv6(ipv4) {
      if (!ipv4 || !/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/.test(ipv4)) return null;
      const parts = ipv4.split('.').map(n => parseInt(n));
      const hex = parts.map(n => n.toString(16).padStart(2, '0')).join('');
      return `::ffff:${hex.slice(0, 4)}:${hex.slice(4)}`;
    }

    function ipv6ToIpv4(ipv6) {
      if (!ipv6 || !ipv6.startsWith('::ffff:')) return null;
      const hex = ipv6.replace('::ffff:', '').replace(/:/g, '');
      if (hex.length !== 8) return null;
      const parts = [];
      for (let i = 0; i < 8; i += 2) {
        parts.push(parseInt(hex.slice(i, i + 2), 16));
      }
      return parts.join('.');
    }

    // Fetch IP information with retry and fallback
    async function fetchIPInfo(attempt = 1, maxAttempts = 4, usePrimaryAPI = true) {
      try {
        const apiUrl = usePrimaryAPI ? 'https://ipapi.co/json/' : 'http://ip-api.com/json/';
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (!response.ok || data.error || data.status === 'fail') {
          throw new Error(data.reason || data.message || 'Failed to fetch IP data');
        }

        // Normalize data (ipapi.co vs ip-api.com)
        const normalizedData = usePrimaryAPI ? data : {
          ip: data.query,
          org: data.isp || data.org,
          city: data.city,
          region: data.regionName,
          postal: data.zip,
          country_name: data.country,
          country_code: data.countryCode,
          timezone: data.timezone,
          latitude: data.lat,
          longitude: data.lon,
          proxy: false,
          hosting: data.isp?.toLowerCase().includes('hosting') || data.org?.toLowerCase().includes('hosting') || false
        };

        // Fetch IPv6 separately if needed
        let ipv6 = null;
        try {
          const ipifyResponse = await fetch('https://api64.ipify.org?format=json');
          const ipifyData = await ipifyResponse.json();
          if (ipifyData.ip.includes(':')) ipv6 = ipifyData.ip;
        } catch (e) {
          console.warn('Failed to fetch IPv6:', e);
        }

        // Update DOM with IP info
        const updateField = (id, value) => {
          const element = document.getElementById(id);
          if (element) element.innerHTML = value || 'Unknown';
        };

        // Handle IPv4 and IPv6
        const isIPv6 = normalizedData.ip.includes(':');
        const ipv4 = isIPv6 ? ipv6ToIpv4(normalizedData.ip) : normalizedData.ip;
        const ipv6Converted = isIPv6 ? normalizedData.ip : ipv4ToIpv6(normalizedData.ip);
        const ipv6Final = ipv6 || ipv6Converted || 'Not available';
        updateField('ipv4', ipv4 ? `${ipv4}${ipv6Converted ? ` (IPv6: ${ipv6Converted})` : ''}` : 'Not available');
        updateField('ipv6', ipv6Final !== 'Not available' ? `${ipv6Final}${ipv4 ? ` (IPv4: ${ipv4})` : ''}` : 'Not available');

        updateField('isp', normalizedData.org);
        updateField('city', normalizedData.city);
        updateField('region', normalizedData.region);
        updateField('zip', normalizedData.postal);
        updateField('country', normalizedData.country_name);
        updateField('timezone', normalizedData.timezone);
        updateField('coordinates', normalizedData.latitude && normalizedData.longitude ? `${normalizedData.latitude}, ${normalizedData.longitude}` : 'Unknown');

        // Display flag with validation
        const flagImg = document.getElementById('flag');
        if (normalizedData.country_code && validCountryCodes.includes(normalizedData.country_code.toLowerCase())) {
          flagImg.src = `https://flagcdn.com/24x18/${normalizedData.country_code.toLowerCase()}.png`;
          flagImg.alt = `${normalizedData.country_name} flag`;
          flagImg.classList.remove('hidden');
        } else {
          console.warn('Invalid or missing country code:', normalizedData.country_code);
          flagImg.src = 'https://img.icons8.com/emoji/24/globe.png';
          flagImg.alt = 'Unknown country';
          flagImg.classList.remove('hidden');
        }

        // Tor and VPN detection
        const orgLower = normalizedData.org?.toLowerCase() || '';
        const isTorUserAgent = /TorBrowser|Tor\/[\d.]+/.test(userAgent);
        const detectedProvider = vpnProviders.find(provider => orgLower.includes(provider));
        const isTor = isTorUserAgent || orgLower.includes('tor') || detectedProvider === 'tor';
        const vpnIndicators = [
          normalizedData.proxy,
          normalizedData.hosting,
          detectedProvider,
          orgLower.includes('vpn'),
          isTor
        ].filter(Boolean).length;
        const isVPN = vpnIndicators >= 1;
        console.log('VPN/Tor Detection Details:', {
          proxy: normalizedData.proxy,
          hosting: normalizedData.hosting,
          org: normalizedData.org,
          detectedProvider,
          isTorUserAgent,
          isTor,
          vpnIndicators,
          isVPN
        });
        const torVpnElement = document.getElementById('tor-vpn');
        const vpnNoteElement = document.getElementById('vpn-note');
        const vpnProviderElement = document.getElementById('vpn-provider');
        if (isVPN) {
          torVpnElement.classList.remove('hidden');
          vpnNoteElement.classList.remove('hidden');
          vpnProviderElement.textContent = isTor ? 'Tor' : (detectedProvider ? `${detectedProvider.charAt(0).toUpperCase() + detectedProvider.slice(1)}` : 'Possible VPN/Tor');
        } else {
          torVpnElement.innerHTML = '<strong>‚úÖ No VPN/Tor detected</strong>';
          torVpnElement.classList.remove('hidden');
        }

        // Update map with IP-based location
        defaultLat = normalizedData.latitude || 0;
        defaultLon = normalizedData.longitude || 0;
        if (ipMarker) map.removeLayer(ipMarker);
        ipMarker = L.marker([defaultLat, defaultLon], { 
          icon: L.icon({ 
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', 
            iconSize: [25, 41], 
            iconAnchor: [12, 41] 
          }) 
        }).addTo(map).bindTooltip("VPN/Tor Location");
        map.setView([defaultLat, defaultLon], 13);
      } catch (error) {
        console.error('Fetch error:', error);
        if (attempt < maxAttempts) {
          console.warn(`Attempt ${attempt} failed: ${error.message}. Retrying${usePrimaryAPI ? ' with primary API' : ' with fallback API'}...`);
          setTimeout(() => fetchIPInfo(attempt + 1, maxAttempts, usePrimaryAPI), 3000);
        } else if (usePrimaryAPI) {
          console.warn('Primary API failed. Trying fallback API...');
          fetchIPInfo(1, maxAttempts, false);
        } else {
          const errorElement = document.getElementById('error');
          if (errorElement) {
            errorElement.textContent = `Failed to fetch IP information after ${maxAttempts} attempts. Please check your connection or try again later.`;
            errorElement.classList.remove('hidden');
          }
          ['ipv4', 'ipv6', 'isp', 'city', 'region', 'zip', 'country', 'timezone', 'coordinates'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.innerHTML = 'Unknown';
          });
          const flagImg = document.getElementById('flag');
          if (flagImg) {
            flagImg.src = 'https://img.icons8.com/emoji/24/globe.png';
            flagImg.alt = 'Unknown country';
            flagImg.classList.remove('hidden');
          }
        }
      }
    }

    // Fetch IP info on load
    fetchIPInfo();

    // Check geolocation availability
    const locateButton = document.getElementById('locate');
    const toggleButton = document.getElementById('toggle-map');
    if (!navigator.geolocation) {
      locateButton.disabled = true;
      locateButton.title = 'Geolocation not supported by your browser';
      toggleButton.disabled = true;
      toggleButton.title = 'Geolocation not supported by your browser';
    }

    // Attempt to get real location on page load
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          realLat = pos.coords.latitude;
          realLon = pos.coords.longitude;
          if (realMarker) map.removeLayer(realMarker);
          realMarker = L.marker([realLat, realLon], { 
            icon: L.icon({ 
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', 
              iconSize: [25, 41], 
              iconAnchor: [12, 41] 
            }) 
          }).addTo(map).bindTooltip("Real Location").openPopup();
          map.setView([realLat, realLon], 13);
          toggleButton.disabled = false;
          toggleButton.title = 'Toggle between VPN/Tor and real location views';
        },
        err => {
          console.warn("Geolocation error: " + err.message);
          locateButton.title = 'Geolocation permission denied or unavailable';
          toggleButton.title = 'Geolocation permission denied or unavailable';
        },
        { timeout: 8000, maximumAge: 60000 }
      );
    }

    // Refresh real location on button click
    locateButton.addEventListener('click', () => {
      if (navigator.geolocation) {
        locateButton.disabled = true;
        locateButton.innerHTML = '<span class="spinner"></span> Fetching...';
        navigator.geolocation.getCurrentPosition(
          pos => {
            realLat = pos.coords.latitude;
            realLon = pos.coords.longitude;
            if (realMarker) map.removeLayer(realMarker);
            realMarker = L.marker([realLat, realLon], { 
              icon: L.icon({ 
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', 
                iconSize: [25, 41], 
                iconAnchor: [12, 41] 
              }) 
            }).addTo(map).bindTooltip("Real Location").openPopup();
            map.setView([realLat, realLon], 13);
            toggleButton.disabled = false;
            toggleButton.title = 'Toggle between VPN/Tor and real location views';
            locateButton.disabled = false;
            locateButton.innerHTML = 'üìç Refresh Real Location';
          },
          err => {
            alert(`Geolocation error: ${err.message}. Please enable location access in your browser settings and ensure GPS/Wi-Fi is available.`);
            locateButton.disabled = false;
            locateButton.title = 'Retry after enabling geolocation';
            locateButton.innerHTML = 'üìç Refresh Real Location';
          },
          { timeout: 8000, maximumAge: 60000 }
        );
      } else {
        alert('Geolocation is not supported by your browser.');
        locateButton.disabled = false;
        locateButton.innerHTML = 'üìç Refresh Real Location';
      }
    });

    let showingRealLocation = false;
    toggleButton.addEventListener('click', () => {
      if (!realLat || !realLon) {
        alert('Real location unavailable. Please use "Refresh Real Location" and allow geolocation.');
        return;
      }
      if (showingRealLocation) {
        if (defaultLat && defaultLon) {
          map.setView([defaultLat, defaultLon], 13);
          if (ipMarker) ipMarker.openPopup();
          showingRealLocation = false;
          toggleButton.textContent = 'Toggle to Real Location';
        }
      } else {
        map.setView([realLat, realLon], 13);
        if (realMarker) realMarker.openPopup();
        showingRealLocation = true;
        toggleButton.textContent = 'Toggle to VPN/Tor Location';
      }
    });
  </script>
</body>
</html>
